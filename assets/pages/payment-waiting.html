<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt vé thành công | FlyViet</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 10px;
            --box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .section-padding {
            padding: 50px 0;
        }
        
        .success-header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 1s ease;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-size: 36px;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
            animation: pulse 2s infinite;
            transition: var(--transition);
        }
        
        .success-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--warning-color);
        }
        
        .booking-reference {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            display: inline-block;
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .booking-reference strong {
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
        }
        
        .success-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            margin-bottom: 50px;
            animation: slideUp 0.8s ease;
            position: relative;
            overflow: hidden;
            border-top: 5px solid var(--warning-color);
        }
        
        .info-section {
            margin-bottom: 40px;
            transition: var(--transition);
        }
        
        .info-section:hover {
            transform: translateY(-5px);
        }
        
        .info-section h3 {
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .info-section h3 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .flight-details, .payment-details, .booking-status {
            line-height: 1.8;
            padding: 15px;
            background-color: #f8fbff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .flight-details p, .payment-details p, .booking-status p {
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
        }
        
        .flight-details strong, .payment-details strong, .booking-status strong {
            min-width: 140px;
            display: inline-block;
            color: #555;
        }
        
        .passenger-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .passenger-table th {
            background-color: #f0f6ff;
            color: var(--primary-color);
            text-align: left;
            padding: 12px 15px;
            font-weight: 500;
        }
        
        .passenger-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .passenger-table tr:last-child td {
            border-bottom: none;
        }
        
        .passenger-table tr:hover td {
            background-color: #f8fbff;
        }
        
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0052a3;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .status-badge.paid {
            background-color: #e8f7ee;
            color: var(--success-color);
        }
        
        .status-badge.pending {
            background-color: #fff9e6;
            color: #e6a400;
        }
        
        .status-badge.unpaid {
            background-color: #f8f9fa;
            color: var(--secondary-color);
        }
        
        /* Divider element with plane icon */
        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: #ccc;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: #eee;
        }

        .divider i {
            padding: 0 15px;
            color: var(--primary-color);
            font-size: 20px;
        }
        
        /* Success actions */
        .success-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        /* Waiting notification */
        .waiting-notification {
            background-color: #fff9e6;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .waiting-notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--warning-color);
            animation: loadingBar 2s infinite linear;
        }

        /* Notification popup */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 10px 20px rgba(255, 193, 7, 0.4); }
            100% { transform: scale(1); box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3); }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes slideUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes loadingBar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .success-content {
                padding: 25px;
            }
            
            .flight-details strong, .payment-details strong {
                min-width: 120px;
            }
            
            .booking-reference {
                display: block;
                width: 90%;
                margin: 0 auto 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>FlyViet</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="../../index.html" >Trang chủ</a></li>
                    <li><a href="khuyen-mai.html">Khuyến mãi</a></li>
                    <li><a href="ticket-search.html">Tra cứu vé</a></li>
                    <li><a href="ho-tro.html">Hỗ trợ</a></li>
                    <li><a href="lien-he.html">Liên hệ</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container section-padding">
        <div class="success-header">
            <div class="success-icon">
                <i class="fas fa-clock"></i>
            </div>
            <h2 class="success-title">Đơn hàng đang chờ xử lý</h2>
            <p class="booking-reference">Mã đặt chỗ của bạn: <strong id="booking-reference">FV12345678</strong></p>
            <p>Chúng tôi đã nhận được thông tin đặt vé của bạn và đang chờ xác nhận thanh toán.</p>
        </div>
        
        <div class="success-content">
            <div class="waiting-notification">
                <p style="margin: 0; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: var(--warning-color);"></i>
                    Trạng thái đơn hàng sẽ tự động cập nhật, bạn có thể đợi hoặc làm mới trang để kiểm tra
                </p>
            </div>
            
            <div id="booking-info" class="info-section">
                <h3><i class="fas fa-receipt"></i> Thông tin đặt vé</h3>
                <div class="booking-status">
                    <p>
                        <strong>Trạng thái:</strong> 
                        <span class="status-badge pending">Đang chờ xác nhận</span>
                    </p>
                    <p><strong>Thời gian đặt:</strong> <span id="booking-time">--/--/---- --:--</span></p>
                </div>
            </div>

            <div id="flight-info" class="info-section">
                <h3><i class="fas fa-plane-departure"></i> Thông tin chuyến bay</h3>
                <div class="flight-details">
                    <p>Đang tải thông tin...</p>
                </div>
            </div>
            
            <div class="divider">
                <i class="fas fa-users"></i>
            </div>
            
            <div id="passenger-info" class="info-section">
                <h3><i class="fas fa-users"></i> Thông tin hành khách</h3>
                <p>Đang tải thông tin...</p>
            </div>
            
            <div class="divider">
                <i class="fas fa-credit-card"></i>
            </div>
            
            <div id="payment-info" class="info-section">
                <h3><i class="fas fa-credit-card"></i> Thông tin thanh toán</h3>
                <div class="payment-details">
                    <p>Đang tải thông tin...</p>
                </div>
            </div>
            
            <div class="success-actions">
                <button id="check-status" class="btn-primary">
                    <i class="fas fa-sync-alt"></i> Kiểm tra trạng thái
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-columns">
                <div class="footer-column">
                    <h3>FlyViet</h3>
                    <p>Đặt vé máy bay trực tuyến nhanh chóng, tiện lợi với giá tốt nhất.</p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h4>Thông tin</h4>
                    <ul>
                        <li><a href="#">Về chúng tôi</a></li>
                        <li><a href="#">Điều khoản sử dụng</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                        <li><a href="#">Câu hỏi thường gặp</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Hỗ trợ</h4>
                    <ul>
                        <li><a href="#">Trung tâm trợ giúp</a></li>
                        <li><a href="#">Hướng dẫn đặt vé</a></li>
                        <li><a href="#">Chính sách hoàn hủy</a></li>
                        <li><a href="#">Chính sách bảo hiểm</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Liên hệ</h4>
                    <ul class="contact-info">
                        <li><i class="fas fa-map-marker-alt"></i> 123 Đường ABC, Quận 1, TP.HCM</li>
                        <li><i class="fas fa-phone"></i> 1900 1234</li>
                        <li><i class="fas fa-envelope"></i> support@flyviet.vn</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 FlyViet. Tất cả các quyền được bảo lưu. ( Nhóm 12 )</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy booking ID từ URL hoặc từ sessionStorage
            const urlParams = new URLSearchParams(window.location.search);
            const bookingIdFromUrl = urlParams.get('booking_id');
            const bookingIdFromSession = sessionStorage.getItem('bookingId');
            
            const bookingId = bookingIdFromUrl || bookingIdFromSession;
            
            if (bookingId) {
                // Hiển thị mã booking
                document.getElementById('booking-reference').textContent = bookingId;
                
                // Tải thông tin đặt vé
                loadBookingDetails(bookingId);
                
                // Thiết lập kiểm tra định kỳ
                const statusInterval = setInterval(() => checkBookingStatus(bookingId), 15000); // Kiểm tra mỗi 15 giây
                
                // Lưu interval ID để có thể xóa nếu cần
                window.statusCheckInterval = statusInterval;
                
                // Thiết lập sự kiện cho nút kiểm tra
                document.getElementById('check-status').addEventListener('click', function() {
                    // Hiển thị thông báo đang kiểm tra
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
                    this.disabled = true;
                    
                    // Kiểm tra trạng thái
                    checkBookingStatus(bookingId, true).then(() => {
                        // Sau khi kiểm tra xong, khôi phục nút
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-sync-alt"></i> Kiểm tra trạng thái';
                            this.disabled = false;
                        }, 1000);
                    });
                });
            } else {
                // Không tìm thấy booking ID
                document.querySelector('.success-content').innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <h3>Không tìm thấy thông tin đặt vé</h3>
                        <p>Vui lòng quay lại trang chủ và thử lại.</p>
                        <a href="../../index.html" class="btn-primary" style="margin-top: 20px;">Về trang chủ</a>
                    </div>
                `;
            }
        });
        
        async function loadBookingDetails(bookingId) {
            try {
                showLoading();
                
                const response = await fetch(`http://localhost:3000/api/bookings/${bookingId}`);
                
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin đặt vé');
                }
                
                const data = await response.json();
                
                // Kiểm tra nếu đã thanh toán, chuyển đến trang success
                if (data.booking.payment_status === 'paid') {
                    clearInterval(window.statusCheckInterval);
                    window.location.href = `payment-success.html?booking_id=${bookingId}`;
                    return;
                }
                
                // Cập nhật trạng thái đơn hàng
                document.querySelector('.status-badge').textContent = formatPaymentStatus(data.booking.payment_status);
                document.querySelector('.status-badge').className = `status-badge ${data.booking.payment_status}`;
                
                // Cập nhật thời gian đặt vé
                const bookingTime = new Date(data.booking.booking_time);
                document.getElementById('booking-time').textContent = formatDate(bookingTime);
                
                // Determine if this is a one-way or round-trip booking
                const isRoundTrip = data.booking.is_round_trip === 1;
                
                // Hiển thị thông tin chuyến bay
                const flightInfoElement = document.getElementById('flight-info');
                
                // Start building HTML for flight info
                let flightInfoHTML = `
                    <h3><i class="fas fa-plane-departure"></i> Thông tin chuyến bay</h3>
                    <div class="flight-details">
                        <p><strong>Loại vé:</strong> ${isRoundTrip ? 'Khứ hồi' : 'Một chiều'}</p>
                        <p><strong>Hạng vé:</strong> ${formatTravelClass(data.booking.travel_class)}</p>
                `;
                
                // Add departure flight details
                if (data.departureFlight) {
                    flightInfoHTML += `
                        <div ${isRoundTrip ? 'style="margin-bottom: 20px; border-bottom: 1px dashed #ddd; padding-bottom: 15px;"' : ''}>
                            ${isRoundTrip ? '<h4 style="margin-top: 15px; color: #0066cc;">CHUYẾN ĐI</h4>' : ''}
                            <p><strong>Chuyến bay:</strong> ${data.departureFlight.airline} (${data.departureFlight.id})</p>
                            <p><strong>Ngày bay:</strong> ${data.departureFlight.date}</p>
                            <p><strong>Khởi hành:</strong> ${getAirportName(data.departureFlight.departure)} (${data.departureFlight.departureTime})</p>
                            <p><strong>Điểm đến:</strong> ${getAirportName(data.departureFlight.destination)} (${data.departureFlight.arrivalTime})</p>
                            <p><strong>Thời gian bay:</strong> ${data.departureFlight.duration}</p>
                        </div>
                `;
                }
                
                // Add return flight details if this is a round-trip booking
                if (isRoundTrip && data.returnFlight) {
                    flightInfoHTML += `
                        <div>
                            <h4 style="margin-top: 15px; color: #0066cc;">CHUYẾN VỀ</h4>
                            <p><strong>Chuyến bay:</strong> ${data.returnFlight.airline} (${data.returnFlight.id})</p>
                            <p><strong>Ngày bay:</strong> ${data.returnFlight.date}</p>
                            <p><strong>Khởi hành:</strong> ${getAirportName(data.returnFlight.departure)} (${data.returnFlight.departureTime})</p>
                            <p><strong>Điểm đến:</strong> ${getAirportName(data.returnFlight.destination)} (${data.returnFlight.arrivalTime})</p>
                            <p><strong>Thời gian bay:</strong> ${data.returnFlight.duration}</p>
                        </div>
                    `;
                }
                
                flightInfoHTML += `</div>`;
                flightInfoElement.innerHTML = flightInfoHTML;
                
                // Hiển thị thông tin hành khách
                const passengerInfoElement = document.getElementById('passenger-info');
                passengerInfoElement.innerHTML = `
                    <h3><i class="fas fa-users"></i> Thông tin hành khách</h3>
                    <div class="passenger-list">
                        <table class="passenger-table">
                            <thead>
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Giới tính</th>
                                    <th>Số hộ chiếu/CMND</th>
                                    <th>Loại hành khách</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.passengers.map(passenger => `
                                    <tr>
                                        <td>${passenger.full_name}</td>
                                        <td>${formatGender(passenger.gender)}</td>
                                        <td>${passenger.passport_number}</td>
                                        <td>${formatPassengerType(passenger.passenger_type)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Hiển thị thông tin thanh toán
                const paymentInfoElement = document.getElementById('payment-info');
                paymentInfoElement.innerHTML = `
                    <h3><i class="fas fa-credit-card"></i> Thông tin thanh toán</h3>
                    <div class="payment-details">
                        <p><strong>Người đặt:</strong> ${data.booking.contact_name}</p>
                        <p><strong>Email:</strong> ${data.booking.email || 'N/A'}</p>
                        <p><strong>Điện thoại:</strong> ${data.booking.phone || 'N/A'}</p>
                        <p><strong>Tổng tiền:</strong> ${formatCurrency(data.booking.total_amount)}</p>
                        ${data.booking.promo_code ? `<p><strong>Mã khuyến mãi:</strong> <span class="status-badge" style="background-color: #e6f7ff; color: #0066cc">${data.booking.promo_code}</span></p>` : ''}
                        
                        <!-- Thông tin phương thức thanh toán -->
                        ${data.paymentInfo ? `
                            <p><strong>Phương thức thanh toán:</strong> ${formatPaymentMethod(data.paymentInfo.method)}</p>
                            <p><strong>Thời gian thanh toán:</strong> ${formatDate(data.paymentInfo.payment_date)}</p>
                        ` : ''}
                        
                        <p><strong>Trạng thái thanh toán:</strong> <span class="status-badge ${data.booking.payment_status}">${formatPaymentStatus(data.booking.payment_status)}</span></p>
                    </div>
                `;
                
                hideLoading();
                
            } catch (error) {
                console.error('Lỗi khi tải thông tin đặt vé:', error);
                document.querySelector('.success-content').innerHTML += `
                    <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 20px;">
                        <p><strong>Lỗi:</strong> Không thể tải thông tin đặt vé. Vui lòng thử lại sau.</p>
                    </div>
                `;
                hideLoading();
            }
        }
        
        async function checkBookingStatus(bookingId, showNotification = false) {
            try {
                const response = await fetch(`http://localhost:3000/api/bookings/${bookingId}`);
                
                if (!response.ok) {
                    throw new Error('Không thể kiểm tra trạng thái đặt vé');
                }
                
                const data = await response.json();
                
                // Cập nhật trạng thái hiển thị
                const statusBadges = document.querySelectorAll('.status-badge');
                statusBadges.forEach(badge => {
                    badge.textContent = formatPaymentStatus(data.booking.payment_status);
                    badge.className = `status-badge ${data.booking.payment_status}`;
                });
                
                // Nếu đã thanh toán, chuyển đến trang success
                if (data.booking.payment_status === 'paid') {
                    // Hiển thị thông báo trước khi chuyển trang (nếu được yêu cầu)
                    if (showNotification) {
                        showSuccessNotification('Thanh toán đã được xác nhận! Đang chuyển hướng...');
                        
                        setTimeout(() => {
                            clearInterval(window.statusCheckInterval);
                            window.location.href = `payment-success.html?booking_id=${bookingId}`;
                        }, 2000);
                    } else {
                        clearInterval(window.statusCheckInterval);
                    window.location.href = `payment-success.html?booking_id=${bookingId}`;
                    }
                }
                
            } catch (error) {
                console.error('Lỗi khi kiểm tra trạng thái đặt vé:', error);
                if (showNotification) {
                    showErrorNotification('Không thể kiểm tra trạng thái đặt vé. Vui lòng thử lại sau.');
                }
            }
        }
        
        function showSuccessNotification(message) {
            removeExistingNotifications();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.backgroundColor = 'var(--success-color)';
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-20px)';
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 1700);
        }
        
        function showErrorNotification(message) {
            removeExistingNotifications();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.backgroundColor = 'var(--danger-color)';
            notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-20px)';
                notification.style.transition = 'opacity 0.3s, transform 0.3s';
                
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        function removeExistingNotifications() {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
        }
        
        function showLoading() {
            const statusBtn = document.getElementById('check-status');
            if (statusBtn) {
                statusBtn.disabled = true;
                statusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải...';
            }
        }
        
        function hideLoading() {
            const statusBtn = document.getElementById('check-status');
            if (statusBtn) {
                statusBtn.disabled = false;
                statusBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Kiểm tra trạng thái';
            }
        }
        
        function formatTravelClass(travelClass) {
            const classMap = {
                'ECONOMY': 'Phổ thông',
                'PREMIUM_ECONOMY': 'Phổ thông đặc biệt',
                'BUSINESS': 'Thương gia',
                'FIRST': 'Hạng nhất'
            };
            return classMap[travelClass] || travelClass;
        }
        
        function formatGender(gender) {
            if (!gender) return 'N/A';
            
            const genderMap = {
                'male': 'Nam',
                'female': 'Nữ',
                'other': 'Khác'
            };
            
            return genderMap[gender.toLowerCase()] || gender;
        }
        
        function formatPassengerType(type) {
            if (!type) return 'Người lớn';
            
            const typeMap = {
                'ADULT': 'Người lớn',
                'CHILD': 'Trẻ em',
                'INFANT': 'Em bé'
            };
            
            return typeMap[type] || type;
        }
        
        function formatPaymentStatus(status) {
            const statusMap = {
                'unpaid': 'Chờ xác nhận',
                'pending': 'Đang xử lý',
                'paid': 'Đã thanh toán',
                'cancelled': 'Đã hủy',
                'refunded': 'Đã hoàn tiền'
            };
            
            return statusMap[status] || status;
        }
        
        function formatDate(date) {
            if (!date) return '--/--/---- --:--';
            
            // Create a new date object to ensure proper parsing
            const dateObj = new Date(date);
            
            // Ensure the date is valid before formatting
            if (isNaN(dateObj.getTime())) return '--/--/---- --:--';
            
            // Use a more explicit formatting approach to avoid timezone issues
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            const hours = String(dateObj.getHours()).padStart(2, '0');
            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
            
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        
        function formatCurrency(amount) {
            if (!amount && amount !== 0) return 'N/A';
            
            try {
                // Sử dụng NumberFormat có độ chính xác cao hơn
                const formatter = new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'VND',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0
                });
                
                return formatter.format(amount);
            } catch (e) {
                // Fallback nếu có lỗi với Intl API
                return amount.toLocaleString('vi-VN') + ' ₫';
            }
        }

        // Helper function to get airport name from code
        function getAirportName(code) {
            const airports = {
                'HAN': 'Hà Nội (HAN)',
                'SGN': 'Hồ Chí Minh (SGN)',
                'DAD': 'Đà Nẵng (DAD)',
                'CXR': 'Nha Trang (CXR)',
                'PQC': 'Phú Quốc (PQC)'
            };
            return airports[code] || code;
        }
        
        // Helper function to format payment method
        function formatPaymentMethod(method) {
            const methodMap = {
                'bank_transfer': 'Chuyển khoản ngân hàng',
                'momo': 'Ví điện tử MoMo',
                'credit_card': 'Thẻ tín dụng',
                'debit_card': 'Thẻ ghi nợ'
            };
            
            return methodMap[method] || method;
        }
        
        // Helper function to format transaction info
        function formatTransactionInfo(infoStr) {
            try {
                // Try to parse as JSON
                const info = JSON.parse(infoStr);
                let result = '';
                
                if (info.phoneNumber) {
                    result += `SĐT: ${info.phoneNumber}`;
                }
                
                if (info.accountNumber) {
                    result += `Số tài khoản: ${info.accountNumber}`;
                }
                
                if (info.bankName) {
                    result += `${result ? ', ' : ''}Ngân hàng: ${info.bankName}`;
                }
                
                if (info.accountName) {
                    result += `${result ? ', ' : ''}Tên TK: ${info.accountName}`;
                }
                
                if (info.transactionDate) {
                    const date = new Date(info.transactionDate);
                    if (!isNaN(date.getTime())) {
                        result += `${result ? ', ' : ''}Ngày giao dịch: ${formatDate(date)}`;
                    }
                }
                
                return result || infoStr;
            } catch (e) {
                // If not valid JSON, return as is
                return infoStr;
            }
        }
    </script>
</body>
</html>
